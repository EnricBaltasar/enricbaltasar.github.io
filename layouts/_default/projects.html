{{- define "main" }}

<div class="projects-container">

<header class="page-header">
  <h1>{{ .Title }}</h1>
  {{- with .Description }}
  <div class="post-description">{{ . }}</div>
  {{- end }}
</header>

{{- $raw := .Params.projects }}
{{- /* Build sortable list: use finish for sort key, "present" → "9999", pad YYYY to YYYY-00 */ -}}
{{- $sortable := slice }}
{{- range $raw }}
  {{- $f := .finish | default "0000" }}
  {{- $sortKey := $f }}
  {{- if eq $f "present" }}{{ $sortKey = "9999-99" }}{{ end }}
  {{- if not (findRE `-` $sortKey) }}{{ $sortKey = printf "%s-00" $sortKey }}{{ end }}
  {{- $sortable = $sortable | append (dict "project" . "sortKey" $sortKey) }}
{{- end }}
{{- $sorted := sort $sortable "sortKey" "desc" }}
{{- $projects := slice }}
{{- range $sorted }}
  {{- $projects = $projects | append .project }}
{{- end }}

{{- /* Count projects per category */ -}}
{{- $scratch := newScratch }}
{{- $catSet := slice }}
{{- range $projects }}
  {{- $cats := split .categories " " }}
  {{- range $cats }}
    {{- if ne . "" }}
      {{- $scratch.Add (printf "cat_%s" .) 1 }}
      {{- if not (in $catSet .) }}
        {{- $catSet = $catSet | append . }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- $catNames := dict
  "startups" "Startups"
  "nonprofits" "Nonprofits"
  "languages" "Languages"
  "education" "Education"
  "writing" "Writing"
  "adventures" "Life"
}}

{{- /* Count top projects */ -}}
{{- $topCount := 0 }}
{{- range $projects }}{{- if .top }}{{ $topCount = add $topCount 1 }}{{ end }}{{- end }}

{{- /* Sort tabs by count desc, then alphabetically */ -}}
{{- $tabItems := slice }}
{{- range $catSet }}
  {{- $count := $scratch.Get (printf "cat_%s" .) }}
  {{- if $count }}
    {{- $tabItems = $tabItems | append (dict "cat" . "count" $count "sortKey" (printf "%04d_%s" (sub 9999 $count) .)) }}
  {{- end }}
{{- end }}
{{- $tabItems = sort $tabItems "sortKey" }}

<div class="project-filter">
  <a href="#top" class="filter-btn project-filter-btn project-filter-top active" data-category="top">Top stories <span class="filter-count">{{ $topCount }}</span></a>
  <a href="#all" class="filter-btn project-filter-btn project-filter-all" data-category="all">All projects <span class="filter-count">{{ len $projects }}</span></a>
  {{- range $tabItems }}
    <a href="#{{ .cat }}" class="filter-btn project-filter-btn" data-category="{{ .cat }}">{{ index $catNames .cat }} <span class="filter-count">{{ .count }}</span></a>
  {{- end }}
</div>

<div class="project-grid">
  {{- range $projects }}
  {{- $hasURL := and .url (ne .url "") (ne .url "#") }}
  {{- $isExternal := and $hasURL (hasPrefix .url "http") }}
  {{- $hasImage := and .image (ne .image "") }}
  {{- if $hasURL }}<a href="{{ .url }}"{{ if $isExternal }} target="_blank" rel="noopener noreferrer"{{ end }} class="project-card{{ if .top }} project-top{{ end }}" data-categories="{{ .categories }}"{{ if .top }} data-top="true"{{ end }}>{{ else }}<div class="project-card{{ if .top }} project-top{{ end }}" data-categories="{{ .categories }}"{{ if .top }} data-top="true"{{ end }}>{{ end }}
    {{- if .top }}<span class="project-top-badge"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Top</span>{{ end }}
    <h2 class="project-title">{{ .title }}</h2>
    {{- if $hasImage }}
    <div class="project-image">
      <img src="{{ .image }}" alt="" loading="lazy">
    </div>
    {{- end }}
    <div class="project-body">
      {{- with .stat }}
      <div class="project-stat">{{ . }}</div>
      {{- end }}
      <p class="project-description">{{ .description }}</p>
      {{- with .ps }}
      <hr class="project-ps-hr">
      <p class="project-ps">{{ . }}</p>
      {{- end }}
      <div class="project-footer">
        <span class="project-categories">{{- range $cat := split .categories " " }}{{- if ne $cat "" }}<span class="project-cat-badge">{{ index $catNames $cat }}</span>{{ end }}{{- end }}</span>
        <span class="project-year">{{- if .start }}{{ .start | replaceRE `-\d{2}$` "" }}–{{ .finish | replaceRE `-\d{2}$` "" }}{{ else }}{{ .finish | replaceRE `-\d{2}$` "" }}{{ end -}}</span>
      </div>
    </div>
  {{- if $hasURL }}</a>{{ else }}</div>{{ end }}
  {{- end }}
</div>

<div class="project-empty" style="display:none;">
  No projects found in this category.
</div>

</div>{{/* end .projects-container */}}

<script>
(function() {
  var buttons = document.querySelectorAll('.project-filter-btn');
  var cards = document.querySelectorAll('.project-card');
  var empty = document.querySelector('.project-empty');
  var grid = document.querySelector('.project-grid');

  function getCategory() {
    var hash = location.hash.replace('#', '');
    return hash || 'top';
  }

  function applyFilter() {
    var activeCategory = getCategory();
    var visibleCount = 0;
    cards.forEach(function(card) {
      var match;
      if (activeCategory === 'all') {
        match = true;
      } else if (activeCategory === 'top') {
        match = card.hasAttribute('data-top');
      } else {
        var cats = ' ' + card.getAttribute('data-categories') + ' ';
        match = cats.indexOf(' ' + activeCategory + ' ') !== -1;
      }
      card.style.display = match ? '' : 'none';
      if (match) visibleCount++;
    });
    empty.style.display = visibleCount === 0 ? '' : 'none';
    grid.classList.toggle('filter-top-active', activeCategory === 'top');
    buttons.forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-category') === activeCategory);
    });
  }

  applyFilter();

  buttons.forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      history.pushState(null, '', btn.getAttribute('href'));
      applyFilter();
    });
  });

  window.addEventListener('popstate', applyFilter);
})();
</script>

{{- end }}
